spring.application.name=QLSV

# Port - Railway sẽ tự động set PORT env variable, fallback về 8080 cho local
server.port=${PORT:8080}

# Database - Sử dụng environment variables cho production, fallback về local cho development
# Railway MySQL format: mysql://user:password@host:port/dbname
spring.datasource.url=${DATABASE_URL:jdbc:mysql://localhost:3306/qlsv}
spring.datasource.username=${DB_USERNAME:root}
spring.datasource.password=${DB_PASSWORD:huy12345}
spring.datasource.driver-class-name=${DB_DRIVER:com.mysql.cj.jdbc.Driver}

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=600000

# Redis Configuration (optional - for token caching)
spring.cache.type=redis
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}

# ========================================
# LOGGING CONFIGURATION
# ========================================

# Root logging level
logging.level.root=DEBUG

# Spring Boot internal logging (giảm noise)
logging.level.org.springframework=WARN
logging.level.org.hibernate=WARN
logging.level.org.apache=WARN

# Database connection pool logging
logging.level.com.zaxxer.hikari=WARN
logging.level.com.zaxxer.hikari.pool=WARN

# Redis client logging
logging.level.io.lettuce=WARN
logging.level.io.netty=WARN

# JDK security logging
logging.level.jdk.event.security=WARN

# MySQL driver logging
logging.level.com.mysql=WARN

# JMX/RMI logging (monitoring tools)
logging.level.javax.management=WARN
logging.level.javax.management.mbeanserver=WARN
logging.level.sun.rmi=WARN
logging.level.java.management=WARN

# Spring Boot Actuator logging
logging.level.org.springframework.boot.actuate=WARN

# HTTP connection logging
logging.level.sun.net.www.protocol.http=WARN

# Redisson Redis client logging
logging.level.org.redisson=WARN

# Console pattern với màu sắc và thời gian
logging.pattern.console=%clr([%d{yyyy-MM-dd HH:mm:ss.SSS}]){green} %clr([%-5level]){magenta} %clr(%logger{0}){cyan} - %clr(%msg){default}%n
spring.output.ansi.enabled=always
# logging.pattern.console.ansi=true

# File pattern
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%t] %-5level [%logger{0}] - %msg%n

# QLSV specific logging file location
logging.file.name=../logs/qlsv-application.log
logging.file.max-size=10MB
logging.file.max-history=5

# Security Module Configuration
security.base-url=${SECURITY_BASE_URL:http://localhost:8083}

# AOP Configuration
spring.aop.auto=true
spring.aop.proxy-target-class=true

# ========================================
# KAFKA CONFIGURATION
# ========================================

# Kafka Configuration - Railway provides KAFKA_URL or KAFKA_BOOTSTRAP_SERVERS
spring.kafka.bootstrap-servers=${KAFKA_BOOTSTRAP_SERVERS:${KAFKA_URL:localhost:9092}}
spring.kafka.listener.auto-startup=${KAFKA_ENABLED:true}

# Consumer Configuration
spring.kafka.consumer.group-id=qlsv-student-group
spring.kafka.consumer.auto-offset-reset=earliest
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
spring.kafka.consumer.properties.spring.json.trusted.packages=*

# Producer Configuration
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer
spring.kafka.producer.acks=all
spring.kafka.producer.retries=3
spring.kafka.producer.batch-size=16384
spring.kafka.producer.linger-ms=5
spring.kafka.producer.buffer-memory=33554432

# Kafka Topics
kafka.topics.student-events=student-events
kafka.topics.teacher-events=teacher-events
kafka.topics.user-events=user-events

# DLQ Topics (optional - có default values)
kafka.topics.student-events-dlq=student-events-dlq
kafka.topics.teacher-events-dlq=teacher-events-dlq
kafka.topics.user-events-dlq=user-events-dlq

# ========================================
# RESILIENCE4J RATE LIMITER CONFIGURATION
# ========================================
# Rate Limiter được đặt ở CONTROLLER LAYER để giới hạn số lượng requests đến API endpoints

# Rate Limiter cho Student Controller - GET endpoints (read operations)
# limitForPeriod: Số requests được phép trong mỗi period
resilience4j.ratelimiter.instances.student-controller.limitForPeriod=100
# limitRefreshPeriod: Thời gian refresh (PT = Period Time, M = Minutes)
resilience4j.ratelimiter.instances.student-controller.limitRefreshPeriod=PT1M
# timeoutDuration: Thời gian chờ để lấy permission (nếu bucket đầy)
resilience4j.ratelimiter.instances.student-controller.timeoutDuration=PT0S

# Rate Limiter riêng cho Student Controller - PUT endpoint (write operations)
# Tách riêng để không ảnh hưởng đến read operations
resilience4j.ratelimiter.instances.student-update-controller.limitForPeriod=30
resilience4j.ratelimiter.instances.student-update-controller.limitRefreshPeriod=PT1M
resilience4j.ratelimiter.instances.student-update-controller.timeoutDuration=PT0S

# ========================================
# RESILIENCE4J CIRCUIT BREAKER CONFIGURATION
# ========================================
# Circuit Breaker được đặt ở SERVICE LAYER để bảo vệ khỏi external service failures

# Circuit Breaker cho QLSV Service (bảo vệ khi gọi Security Service, Database, etc.)
# slidingWindowSize: Số lượng requests trong sliding window để tính failure rate
resilience4j.circuitbreaker.instances.qlsv-service.slidingWindowSize=10
# minimumNumberOfCalls: Phải có ít nhất N calls mới tính failure rate (tránh false positive)
resilience4j.circuitbreaker.instances.qlsv-service.minimumNumberOfCalls=5
# failureRateThreshold: % failures để chuyển sang OPEN state (50% = 5/10 requests fail)
resilience4j.circuitbreaker.instances.qlsv-service.failureRateThreshold=50
# waitDurationInOpenState: Thời gian đợi trước khi chuyển từ OPEN sang HALF_OPEN
resilience4j.circuitbreaker.instances.qlsv-service.waitDurationInOpenState=60s
# permittedNumberOfCallsInHalfOpenState: Số calls được phép trong HALF_OPEN để test recovery
resilience4j.circuitbreaker.instances.qlsv-service.permittedNumberOfCallsInHalfOpenState=3
